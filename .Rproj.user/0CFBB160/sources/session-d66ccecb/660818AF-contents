# library(targets)
# library(glue)
# # for tree estimation
# library(rpart)
# # For data visualization
# library(rpart.plot)
# library(ggparty)
# library(partykit)
# library(tidyverse)
# 
# tar_load(finscope23_tzn_selected)
# c("financial_access_strand", "bank_or_mobile_money")
# indicator_filter <- "financial_access_strand"

# regression_data %>% names()

estimate_finscope_tree <- function(finscope23_tzn_selected, indicator_filter){
  
  
  regression_data <- finscope23_tzn_selected %>% 
    pivot_longer(
      cols = banked_or_mobile_money:banked,
      names_to = "indicator",
      values_to = "dependent"
    ) %>% 
    filter(
      indicator == indicator_filter,
      age >= 20,
      age <= 24,
      c9_respondent_gender_interviewer_to_observe == "Female"
    ) 
  
  
  # estimate the tree
  cohort_tree <- rpart(
    dependent ~ ., 
    data = regression_data %>% select(-population_weight), 
    method = "anova",
    weights = regression_data$population_weight,
    control = list(max_depth = 4, cp = 0.009)
  )
  
  # create an image file
  png(
    glue("output/model_out/finscope/finscope23tzn_{indicator_filter}_tree.png"), 
    width = 1800, height = 1000
  )
  
  # plot the tree
  rpart.plot(
    cohort_tree,
    tweak = 1.2,
    type = 4,
    main = glue("Tree for Tanzania Finscope 2023 {indicator_filter}")
  )
  
  # visualise the plot
  dev.off()
  
  # ggsave(
  #   ,
  #   plot = reg_tree_plot,
  #   width = 8, height = 6, 
  #   dpi = 300
  # )
  # 
  
  return(cohort_tree)
  
}

# finscope_tzn_2023_selected %>% 
#   mutate(
#     financial_access_strand = case_when(
#       financial_access_strand =="Banked"~1,
#       financial_access_strand == "Other formal non-bank"~1,
#       financial_access_strand == "Excluded"~0,
#       financial_access_strand == "Informal only"~0
#     )  
#   ) %>% 
#   count(financial_access_strand, financial_access_strand_a)
